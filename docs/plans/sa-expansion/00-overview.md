# SA 扩展计划 - 整体概览

## 项目目标
将 panpan 的 Task tool 扩展为四种专门的 Subagent 类型：
- **RemoteSA** - 远程执行隔离
- **WatcherSA** - 资源监控
- **PMSA** - 需求确认与验收
- **LoggerSA** - 客观记录

同时添加**自动诊断修复**基础设施，解决 agent "甩锅给用户"的问题。

## 整体架构
```
┌─────────────────────────────────────────────────────────────────┐
│                     Main Agent (协调者)                          │
│  - SA 可合作但不能嵌套（避免死循环）                               │
└───────────────┬─────────────────────────────────────────────────┘
                │
    ┌───────────┼───────────┬───────────────┬───────────────┐
    ▼           ▼           ▼               ▼               ▼
┌──────────┐┌──────────┐┌──────────┐┌─────────────┐┌─────────────┐
│ Existing ││ RemoteSA ││ WatcherSA││    PMSA     ││  LoggerSA   │
│ (Explore,││ SSH+     ││ GPU/CPU/ ││ 需求确认    ││  (观察者)    │
│  Plan)   ││ Daemon   ││ Disk/... ││ + 验收      ││  记录所有    │
└──────────┘└──────────┘└──────────┘└─────────────┘└─────────────┘
```

## 模块依赖关系
```
┌─────────────────────────────────────────────────────────────────┐
│              Sprint 1: 独立模块（可完全并行）                     │
├─────────────────────────────────────────────────────────────────┤
│  [A] types/           [B] diagnostics/      [C] remote/         │
│  [D] logger/          [E] watcher/monitors/ [F] pm/             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Sprint 2: 工具层（依赖 Sprint 1）                   │
├─────────────────────────────────────────────────────────────────┤
│  [G] tools/remote/    [H] tools/logger/     [I] tools/watcher/  │
│  [J] tools/pm/        [K] 现有工具增强 (Pip等)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Sprint 3: 集成（顺序执行）                          │
├─────────────────────────────────────────────────────────────────┤
│  [L] core/ 修改       [M] agent-loader      [N] tools/mod.ts    │
└─────────────────────────────────────────────────────────────────┘
```

## 模块清单

| 模块 ID | 计划文件 | 依赖 | 可并行 |
|---------|---------|------|--------|
| A | `01-module-A-types.md` | 无 | ✓ |
| B | `02-module-B-diagnostics.md` | 无 | ✓ |
| C | `03-module-C-remote.md` | 无 | ✓ |
| D | `04-module-D-logger.md` | 无 | ✓ |
| E | `05-module-E-watcher.md` | 无 | ✓ |
| F | `06-module-F-pm.md` | 无 | ✓ |
| G-K | `07-sprint2-tools.md` | A-F | 部分并行 |
| L-N | `08-sprint3-integration.md` | G-K | 顺序 |

## 并行开发甘特图
```
天数:    1    2    3    4    5    6    7    8    9   10
        ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
A types ████
B diag  ████████████
C remot ██████████████████
D logge ████████████
E watch ████████████
F pm    ██████████████████
                         G-J tools  ██████████████████
                    K 工具增强      ████████████████████
                                                L-N 集成██████
```

## 开发顺序建议

1. **最先开始**: 模块 A (types) - 定义所有接口契约
2. **可立即并行**: 模块 B, C, D, E, F - 核心服务实现
3. **等待依赖后**: Sprint 2 工具层
4. **最后**: Sprint 3 集成

## 关键约定

### 代码规范
- 使用 Deno + TypeScript
- 工具实现使用 async generator 模式
- 类型定义放在 `src/types/`
- 服务逻辑放在 `src/services/`
- 工具实现放在 `src/tools/`

### 测试约定
- 每个模块完成后可独立验证
- 单元测试优先，集成测试在 Sprint 3

### 合并约定
- 每个模块开发完成后提交 PR
- PR 标题格式: `feat(sa): [模块ID] 模块名称`
